# 下一行预测器 (NLP)

下一行预测器旨在用较小的存储开销提供一个无空泡的快速预测流。它的功能主要由 uBTB 提供。
对于给定的起始地址 PC，uBTB对从 PC 开始的一个预测块做出整体预测。

## uBTB

它用分支历史和 PC 的低位异或索引存储表，
从表中读出的内容直接提供了最精简的预测，
包括下一个预测块的起始地址 nextAddr、这个预测块是否发生分支指令跳转 taken、（如果跳转）跳转指令相对起始地址的偏移 cfiOffset。
另外还提供分支指令的相关信息以更新分支历史，包括是否在条件分支跳转 takenOnBr，以及块内包含分支指令的数目 brNumOH。

我们摒弃了 tag 匹配的做法，这会带来一个问题。在有 tag 匹配的情况下，如果一个预测块没有命中，会将下一个预测块的 PC 置为当前 PC 加预测宽度。为避免浪费，如果在预测块中没有分支指令，则训练时不会写入 uBTB。在这个前提下，如果没有 tag 匹配机制，则很容易把没有分支指令（在 tag 匹配机制下不命中）的预测块预测为另一个跳转的块。针对这种情况，我们引入了另一种预测机制，对当前 PC 是否可能存在有效的分支指令进行预测。这个预测机制的存储结构由取指 PC 直接索引，它的查询结果表示了该取指 PC 是否被写入过。在它指示该 PC 没被写入过的时候，会把下一个 PC 预测为当前 PC 加预测宽度。
